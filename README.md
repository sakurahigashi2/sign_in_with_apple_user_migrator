# Sign In With Apple User Migrator

A CLI tool for migrating existing users when transferring an iOS app using Sign in with Apple to another team.

## Usage

The log level can be specified using the `LOG_LEVEL` environment variable.

| Level | Description |
|--------|------|
| DEBUG  | Outputs detailed logs including debug information |
| INFO   | Outputs standard information logs (default) |
| WARN   | Outputs warning level logs |
| ERROR  | Outputs error level logs |
| FATAL  | Outputs fatal error logs |

### Installation

```bash
git clone https://github.com/sakurahigashi2/sign_in_with_apple_user_migrator.git
cd sign_in_with_apple_user_migrator
bundle install
```

### generate_user_transfer_ids

This is a script to generate migration identifiers for users who are using Apple's Sign in with Apple.  
The migration identifier is required when transferring users.  
To run this script, you need an account registered with the Apple Developer Program.  
Also, please list the IDs of the users to be migrated in a CSV file.  
[Transferring your apps and users to another team](https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team)

```bash
bundle exec ruby bin/sign_in_with_apple_user_migrator generate_user_transfer_ids \
  --client_id='your.app.id' \
  --key_id='YOUR_KEY_ID' \
  --private_key_path='path/to/AuthKey.p8' \
  --team_id='YOUR_TEAM_ID' \
  --transfer_user_id_csv_path='path/to/user_ids.csv' \
  --target_team_id='TARGET_TEAM_ID'
```

#### Options

| Option | Description | Example |
|--------|-------------|---------|
| client_id | Application bundle ID | jp.co.example.app |
| key_id | Key ID created in Apple Developer Portal | XXXXXXXXXX |
| private_key_path | Private key (.p8) file path for Sign in with Apple | ./AuthKey.p8 |
| team_id | Source Apple Developer Team ID | XXXXXXXXXX |
| transfer_user_id_csv_path | CSV file path containing list of user IDs to be migrated | ./user_ids.csv |
| target_team_id | Destination Apple Developer Team ID | AAAAAAAAAA |

#### Sample of transfer_user_id_csv

```csv
user_id
000000.26f8a3931cd640dfaca0ef843c6dummy.0000
000000.26f8a3931cd640dfaca0ef843c6dummy.1111
```

#### Output

The execution results will be saved in `tmp/generated_transfer_ids_YYYYMMDDHHMMSS.csv`.  

Sample output:

```csv
user_id,transfer_id,error
000000.26f8a3931cd640dfaca0ef843c6dummy.0000,000000.rf649c02eb9e3460fb1c03f69990dummy,
000000.26f8a3931cd640dfaca0ef843c6dummy.1111,,"HTTP Status: 400, Error: {""error""=>""invalid_request""}"
```


### migrate_user_transfer_ids

This is a script to accept users who are using Apple's Sign in with Apple.  
It accepts users in the destination team using the `transfer_id` generated by the source team.  
[Bringing new apps and users into your team](https://developer.apple.com/documentation/sign_in_with_apple/bringing_new_apps_and_users_into_your_team)

```bash
bundle exec ruby bin/sign_in_with_apple_user_migrator migrate_user_transfer_ids \
  --client_id='your.app.id' \
  --key_id='YOUR_KEY_ID' \
  --private_key_path='path/to/AuthKey.p8' \
  --team_id='YOUR_TEAM_ID' \
  --transfer_id_csv_path='path/to/transfer_id_csv_path.csv'
```

#### Options

| Option | Description | Example |
|--------|-------------|---------|
| client_id | Application bundle ID | jp.co.example.app |
| key_id | Key ID created in destination Apple Developer Portal | XXXXXXXXXX |
| private_key_path | Private key (.p8) file path for Sign in with Apple | ./AuthKey.p8 |
| team_id | Destination Apple Developer Team ID | XXXXXXXXXX |
| transfer_id_csv_path | CSV file path containing list of transfer IDs to be migrated | ./transfer_id_csv_path.csv |

Note: Make sure to use the destination team's information.

#### Sample of transfer_id_csv

```csv
transfer_id
000000.rf649c02eb9e3460fb1c03f69990dummy
111111.rf649c02eb9e3460fb1c03f69990dummy
```

Note: You can use the CSV file generated by the generate_user_transfer_ids command.

#### Output

The execution results will be saved in `tmp/exchanged_transfer_ids_YYYYMMDDHHMMSS.csv`.

Sample output:

```csv
transfer_id,sub,email,is_private_email,error
000000.rf649c02eb9e3460fb1c03f69990dummy,000000.a1b2c3d4e5f6g7h8i9j0.1234,sample@privaterelay.appleid.com,true,
111111.rf649c02eb9e3460fb1c03f69990dummy,,,,"HTTP Status: 400, Error: {""error""=>""invalid_request""}"
```

## Advanced Usage

After installation, the following classes are provided.

```bash
gem install sign_in_with_apple_user_migrator
```

### Classes

| Class | Description |
|-------|-------------|
| SignInWithAppleUserMigrator::ClientSecretGenerator | Generate client secret (JWT) |
| SignInWithAppleUserMigrator::AccessTokenGenerator | Generate user access token |
| SignInWithAppleUserMigrator::TransferIdGenerator | Generate transfer ID |
| SignInWithAppleUserMigrator::TransferIdExchanger | Migrate transfer ID |

## Trouble Shooting

- [TN3107: Resolving Sign in with Apple response errors](https://developer.apple.com/documentation/technotes/tn3107-resolving-sign-in-with-apple-response-errors)
  - [User migration info response errors](https://developer.apple.com/documentation/technotes/tn3107-resolving-sign-in-with-apple-response-errors#User-migration-info-response-errors)

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
